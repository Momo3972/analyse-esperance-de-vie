---
title: "Analyse de l'espérance de vie"
author: "Lamine"
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
output:
  word_document:
    toc: true
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo    = TRUE,
  warning = FALSE,
  message = FALSE,
)

library(readr)
library(dplyr)
library(naniar)
library(ggplot2)
library(corrplot)
library(MASS)
library(glmnet)
library(randomForest)
library(tidyr)
library(tibble)
library(broom)
```

# 1. Introduction
Ce rapport présente une analyse complète des facteurs influençant l'espérance de vie dans le monde à partir des données de l'Organisation Mondiale de la Santé (2000–2015).

Les grandes étapes incluent :

- importation et nettoyage des données,

- analyse exploratoire,

- modélisation linéaire (simple, LASSO, stepwise),

- modélisation non linéaire (Random Forest),

- comparaison finale des modèles,

- extraction des variables les plus explicatives.

# 2. Importation et nettoyage des données
# 2.1 Importation des données brutes et structure initiale
Rédaction

life <- read_csv("data/Life Expectancy Data.csv")

glimpse(life)
head(life)

# 2.2 Analyse des valeurs manquantes
Rédaction

miss_var_summary(life)
vis_miss(life)

# 2.3 Harmonisation des types et renommage propre
Rédaction

life <- life %>%
mutate(
Country = as.factor(Country),
Status = as.factor(Status),
Year = as.integer(Year)
) %>%
rename(
life_expectancy =`Life expectancy`,
adult_mortality = Adult Mortality`,
infant_deaths = infant deaths`,
alcohol = Alcohol,
percentage_expenditure = percentage expenditure`,
hepatitis_b = `Hepatitis B`,
measles = Measles,
bmi = BMI,
under_five_deaths = `under-five deaths`,
polio = Polio,
total_expenditure = `Total expenditure`,
diphtheria = Diphtheria,
hiv_aids = `HIV/AIDS`,
gdp = GDP,
population = Population,
thinness_1_19 = `thinness  1-19 years`,
thinness_5_9= `thinness  5-9 years`,
income_composition = `Income composition of resources`,
schooling = Schooling
)

names(life)

# 3. Analyse exploratoire
# 3.1 Statistiques descriptives
Rédaction

summary(life)

# 3.2 Corrélations entre variables numériques
Rédaction

life_num <- life %>% select(where(is.numeric))
cor_mat  <- cor(life_num, use = "pairwise.complete.obs")

corrplot(cor_mat, method = "color", tl.cex = 0.6)

# 3.3 Distribution de l'espérance de vie
Rédaction

ggplot(data = life, aes(x = life_expectancy)) +
geom_histogram(bins = 30, fill = "#4C72B0", color = "white") +
labs(
title = "Distribution de l'espérance de vie",
x = "Espérance de vie (années)",
y = "Effectif"
)

# 3.4 Relation avec la mortalité adulte
Rédaction

ggplot(data = life, aes(x = adult_mortality, y = life_expectancy)) +
geom_point(alpha = 0.5) +
labs(
title = "Espérance de vie vs mortalité adulte",
x = "Mortalité adulte",
y = "Espérance de vie (années)"
)

# 3.5 Espérance de vie selon le statut du pays
Rédaction

ggplot(data = life, aes(x = Status, y = life_expectancy, fill = Status)) +
geom_boxplot() +
labs(
title = "Espérance de vie selon le statut du pays",
x = "Statut",
y = "Espérance de vie (années)"
) +
theme(legend.position = "none")

# 3.6 PIB vs espérance de vie (échelle logarithmique)
Rédaction

ggplot(data = life, aes(x = gdp, y = life_expectancy)) +
geom_point(alpha = 0.5) +
scale_x_log10() +
labs(
title = "Espérance de vie vs PIB (log10)",
x = "PIB (log10)",
y = "Espérance de vie (années)"
)

# 4. Nettoyage final
# 4.1 Suppression des NA sur la variable cible
Rédaction

life <- life %>% filter(!is.na(life_expectancy))

# 4.2 Imputation médiane pour les variables numériques
Rédaction

life <- life %>%
mutate(
across(
where(is.numeric),
~ ifelse(is.na(.), median(., na.rm = TRUE), .)
)
)

sum(is.na(life))

# 5. Modélisation linéaire simple
# 5.1 Création des échantillons d'apprentissage et de test
Rédaction

set.seed(123)
n <- nrow(life)
train_idx <- sample(seq_len(n), size = 0.8 * n)

train <- life[train_idx, ]
test <- life[-train_idx, ]

# 5.2 Fonctions de métriques (RMSE, R²)
Rédaction

rmse <- function(y, yhat) sqrt(mean((y - yhat)^2))
r2 <- function(y, yhat) 1 - sum((y - yhat)^2) / sum((y - mean(y))^2)

# 5.3 Modèle linéaire
Rédaction

formule_lm <- life_expectancy ~ adult_mortality + gdp + schooling +
income_composition + hiv_aids + bmi + alcohol + Status + Year

modele_lm <- lm(formule_lm, data = train)
summary(modele_lm)

# 5.4 Évaluation du modèle linéaire
Rédaction

pred_train <- predict(modele_lm, newdata = train)
pred_test <- predict(modele_lm, newdata = test)

rmse_train <- rmse(train$life_expectancy, pred_train)
rmse_test <- rmse(test$life_expectancy, pred_test)
r2_train <- r2(train$life_expectancy, pred_train)
r2_test <- r2(test$life_expectancy, pred_test)

tibble(
jeu = c("train", "test"),
RMSE = c(rmse_train, rmse_test),
R2 = c(r2_train, r2_test)
)

# 6. Sélection de variables
# 6.1 Stepwise AIC
Rédaction

modele_full <- lm(formule_lm, data = train)
modele_step <- stepAIC(modele_full, direction = "both", trace = FALSE)
summary(modele_step)

pred_step_train <- predict(modele_step, newdata = train)
pred_step_test <- predict(modele_step, newdata = test)

rmse_step_train <- rmse(train$life_expectancy, pred_step_train)
rmse_step_test <- rmse(test$life_expectancy, pred_step_test)
r2_step_train <- r2(train$life_expectancy, pred_step_train)
r2_step_test <- r2(test$life_expectancy, pred_step_test)

# 6.2 LASSO
Rédaction

X_train <- model.matrix(formule_lm, data = train)[, -1]
X_test  <- model.matrix(formule_lm, data = test)[, -1]
y_train <- train$life_expectancy
y_test <- test$life_expectancy

set.seed(123)
cv_lasso <- cv.glmnet(X_train, y_train, alpha = 1)
modele_lasso <- glmnet(
X_train, y_train,
alpha = 1,
lambda = cv_lasso$lambda.min
)

pred_lasso_train <- as.numeric(predict(modele_lasso, X_train))
pred_lasso_test <- as.numeric(predict(modele_lasso, X_test))

rmse_lasso_train <- rmse(y_train, pred_lasso_train)
rmse_lasso_test <- rmse(y_test, pred_lasso_test)
r2_lasso_train <- r2(y_train, pred_lasso_train)
r2_lasso_test <- r2(y_test, pred_lasso_test)

# 7. Random Forest
Rédaction

train_rf <- train %>% select(-Country)
test_rf <- test  %>% select(-Country)

set.seed(123)
modele_rf <- randomForest(
life_expectancy ~ .,
data = train_rf,
ntree = 500,
mtry = 4,
importance = TRUE
)

pred_rf_train <- predict(modele_rf, newdata = train_rf)
pred_rf_test <- predict(modele_rf, newdata = test_rf)

rmse_rf_train <- rmse(train_rf$life_expectancy, pred_rf_train)
rmse_rf_test <- rmse(test_rf$life_expectancy, pred_rf_test)
r2_rf_train <- r2(train_rf$life_expectancy, pred_rf_train)
r2_rf_test <- r2(test_rf$life_expectancy, pred_rf_test)

# 8. Comparaison finale des modèles
Rédaction

comparaison_finale <- tibble(
Model = c("Régression linéaire", "LASSO", "Stepwise", "Random Forest"),
RMSE_Train = c(rmse_train, rmse_lasso_train, rmse_step_train, rmse_rf_train),
RMSE_Test = c(rmse_test, rmse_lasso_test, rmse_step_test, rmse_rf_test),
R2_Train = c(r2_train, r2_lasso_train, r2_step_train, r2_rf_train),
R2_Test = c(r2_test, r2_lasso_test, r2_step_test, r2_rf_test)
)

comparaison_finale

# 9. Importance des variables
# 9.1 Modèle linéaire
Rédaction

coeffs <- as.data.frame(summary(modele_lm)$coefficients)
coeffs$Variable <- rownames(coeffs)
coeffs <- coeffs %>% filter(Variable != "(Intercept)")
coeffs$Importance <- abs(coeffs$Estimate)

top_lm <- coeffs %>%
arrange(desc(Importance)) %>%
slice(1:10)

top_lm

# 9.2 Random Forest
Rédaction

imp_rf <- as.data.frame(importance(modele_rf))
imp_rf$Variable <- rownames(imp_rf)

top_rf <- imp_rf %>%
arrange(desc(`%IncMSE`)) %>%
slice(1:10)

top_rf

# 10. Conclusion générale

L'espérance de vie est fortement influencée par :

- le niveau socio-économique (composition du revenu, éducation),

- les indicateurs de santé (mortalité adulte, VIH / SIDA),

- le statut de développement du pays.

Le modèle Random Forest offre la meilleure performance prédictive sur ce jeu de données, en capturant des effets non linéaires et des interactions entre variables.

Les variables les plus importantes sont cohérentes entre les modèles : revenu/éducation, mortalité adulte, VIH/SIDA, indicateurs de nutrition et de dépenses de santé.

Investir dans l'éducation, réduire la mortalité adulte et lutter contre le VIH sont des leviers majeurs pour augmenter l'espérance de vie.

# 11. Fin du document

Rapport généré automatiquement via RMarkdown.
